# define a GCP VM agent to support container management (by default agent doesn't support)
agents:
  provider: "gcp"
  machineType: "n1-standard-4"

steps:
  - group: ":fire: Unit and integration tests run"
    steps:
      - label: ":hammer: CI setup"
        key: "plugin-ci-download"
        command:
          # TODO: change to logstash-plugins org repo, now using personal repo to test
          - "mkdir -p .ci && curl -sL https://github.com/mashhurs/.ci/archive/main.tar.gz | tar zxvf - --skip-old-files --strip-components=1 -C .ci --wildcards '*Dockerfile*' '*docker*' '*.sh'"
      - label: ":docker: Docker setup."
        key: "docker-setup"
        depends_on: "plugin-ci-download"
        command:
          - ".ci/docker-setup.sh"
        env:
          ELASTIC_STACK_VERSION: "8.6.2" # TODO we need to dynamically inject the version